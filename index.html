<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>King & Co. Design - Interior Architecture (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Set Inter font globally */
        /* FIX: Corrected misspelled URL */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #e5e7eb; /* Light gray text */
            min-height: 100vh;
        }
        /* Custom scrollbar for a sleek look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 4px;
        }
    </style>
</head>
<body class="antialiased">

    <header class="sticky top-0 z-50 bg-gray-900/90 backdrop-blur-sm shadow-xl border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <span class="text-xl font-extrabold tracking-tight text-yellow-500">King & Co.</span>
                    <span class="text-sm font-light text-gray-400"> Design</span>
                </div>
                <nav class="flex space-x-4" id="main-nav">
                    <button onclick="navigate('home')" class="nav-link text-gray-300 hover:text-yellow-400 px-3 py-2 rounded-md text-sm font-medium transition duration-150" data-page="home">Home</button>
                    <button onclick="navigate('showcase')" class="nav-link text-gray-300 hover:text-yellow-400 px-3 py-2 rounded-md text-sm font-medium transition duration-150" data-page="showcase">Showcase</button>
                    <button onclick="navigate('contact')" class="nav-link text-gray-300 hover:text-yellow-400 px-3 py-2 rounded-md text-sm font-medium transition duration-150" data-page="contact">Contact Staff</button>
                    <button onclick="navigate('admin')" class="nav-link text-gray-300 hover:text-yellow-400 px-3 py-2 rounded-md text-sm font-medium transition duration-150 flex items-center" data-page="admin" id="admin-nav-button">
						<i data-lucide="gavel" class="w-4 h-4 mr-1"></i>
						
					</button>
                </nav>
            </div>
        </div>
    </header>

    <main id="app-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="loading-indicator" class="text-center text-gray-400 pt-20 hidden">
            <i data-lucide="loader" class="w-10 h-10 animate-spin mx-auto text-yellow-500"></i>
            <p class="mt-4">Initializing database and loading content...</p>
        </div>
    </main>

    <div id="project-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[100] flex items-center justify-center p-4" onclick="closeModal(event)">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-6 border-b border-gray-700 sticky top-0 bg-gray-800 z-10">
                <h3 id="modal-title" class="text-2xl font-bold text-yellow-400">Project Title</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-yellow-400 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-content" class="p-6 space-y-6">
                </div>
        </div>
    </div>

<script>
    // --- GLOBAL SUPABASE/APP STATE ---
    // Functions referenced in HTML onclick MUST be globally defined for immediate access
    let supabase = null;
    let userId = 'public-view'; // Tracks the current user, updated on auth state change
    let projects = []; // The single source of truth for projects
    let currentPage = 'home';
    let isAdminAuthenticated = false; // Controls access to admin forms
    let currentImageIndex = 0; // NEW: For image slideshow in modal
    
    // FIX: Updated with user's credentials
    const SUPABASE_URL = "https://zpdixrsjtrmnlccohqgv.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwZGl4cnNqdHJtbmxjY29ocWd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMTcwOTEsImV4cCI6MjA3NDg5MzA5MX0.v6o-tjyipVY5piR-FVVCYv-3guT_jLih0l5a8G_g51Q";
    const TABLE_NAME = 'showcase_projects';

    // DOM Elements
    const appContainer = document.getElementById('app-container');
    const modal = document.getElementById('project-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    
    // --- MOCK STAFF DATA (Client-side constant) ---
    const MOCK_STAFF = [
        { name: "Alex King", role: "Owner | Budget & Efficiency Specialist", specialty: "Goverment Apartments, Custom Layouts, Small/Tiny Houses", contact: "999-999-9999", icon: "crown" },
        { name: "Hiring Now!", role: "Commercial Design Manager", specialty: "Live-In Businesses, Hidden Spaces, Retail Spaces, Branding Integration", contact: "Apply Now!", icon: "store" },
        { name: "Hiring Now!", role: "Lead Architect", specialty: "Affordable Housing, Efficient Layouts, Warehouse Design", contact: "Apply Now!", icon: "house" },
		{ name: "Hiring Now!", role: "General manager", specialty: "Hiring Staff, Creating Advertisments, Marketing", contact: "Apply Now!", icon: "router" }
    ];

    // --- UTILITY & MODAL FUNCTIONS (Moved to global scope) ---

    function showLoading(show) {
        const loadingIndicator = document.getElementById('loading-indicator');
        if (loadingIndicator) {
            loadingIndicator.classList.toggle('hidden', !show);
        }
        if (appContainer) {
            appContainer.classList.toggle('opacity-50', show);
        }
    }
    
    function renderIcons() {
        if (window.lucide) {
            window.lucide.createIcons();
        }
    }

    function showMessageBox(title, message) {
        modalTitle.textContent = title;
        modalContent.innerHTML = `<p class="text-lg text-gray-300">${message}</p>`;
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    function showConfirmBox(title, message, onConfirm) {
        modalTitle.textContent = title;
        modalContent.innerHTML = `
            <p class="text-lg text-gray-300 mb-6">${message}</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition">Cancel</button>
                <button id="confirm-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-500 transition">Delete</button>
            </div>
        `;
        document.getElementById('cancel-btn').onclick = closeModal;
        document.getElementById('confirm-btn').onclick = () => {
            onConfirm();
            closeModal();
        };
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        renderIcons(); // Ensure icons within the modal are rendered
    }

    function closeModal(event) {
        if (!event || event.target.id === 'project-modal' || !event.target.closest('#project-modal > div')) {
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        modalContent.innerHTML = '';
    }
    
    // --- SLIDESHOW LOGIC (NEW) ---

    function showImage(imageUrls) {
        const imageContainer = document.getElementById('image-slideshow-container');
        const prevButton = document.getElementById('prev-image-btn');
        const nextButton = document.getElementById('next-image-btn');
        const counterElement = document.getElementById('image-counter');
        
        if (!imageContainer || imageUrls.length === 0) return;

        // Update the image source
        imageContainer.innerHTML = `
            <img src="${imageUrls[currentImageIndex]}" 
                 alt="Project Image ${currentImageIndex + 1}" 
                 class="w-full h-auto max-h-[60vh] object-contain rounded-lg shadow-xl"
                 onerror="this.onerror=null;this.src='https://placehold.co/800x600/374151/9ca3af?text=Image+Unavailable';" />
        `;
        
        // Update counter
        counterElement.textContent = `Image ${currentImageIndex + 1} of ${imageUrls.length}`;

        // Update button visibility
        prevButton.classList.toggle('hidden', currentImageIndex === 0);
        nextButton.classList.toggle('hidden', currentImageIndex === imageUrls.length - 1);
    }

    // Global functions for buttons
    window.nextImage = (imageUrls) => {
        if (currentImageIndex < imageUrls.length - 1) {
            currentImageIndex++;
            showImage(imageUrls);
        }
    };

    window.prevImage = (imageUrls) => {
        if (currentImageIndex > 0) {
            currentImageIndex--;
            showImage(imageUrls);
        }
    };

    // --- SUPABASE SETUP & DATA LISTENERS ---

    function setupSupabase() {
        if (!window.supabase || SUPABASE_URL.includes('your-supabase-project')) {
            console.error("Supabase not initialized: Please replace placeholder URL and Key with actual credentials.");
            showMessageBox('Supabase Setup Error', 'Please replace the placeholder URL and Key in the script with your actual Supabase credentials for full functionality.');
            return;
        }

        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Listen for authentication changes (New Auth Flow)
            supabase.auth.onAuthStateChange((event, session) => {
                if (session?.user) {
                    isAdminAuthenticated = true;
                    // Use the user's email or ID for clear identification
                    userId = session.user.email || session.user.id; 
                    console.log("User authenticated:", userId);
                } else {
                    isAdminAuthenticated = false;
                    userId = 'public-view';
                }
                // Re-render the admin page if user logs in/out while viewing it
                if (currentPage === 'admin') {
                    navigate('admin', true);
                }
            });
            
            // Initial data fetch
            fetchProjectsOnce(); 
        } catch (error) {
            console.error("Supabase client initialization failed:", error);
            showMessageBox('Initialization Error', 'Failed to initialize Supabase client. Check console for details.');
        }
    }

    // FIX: Simplified data fetching, removing incorrect .subscribe usage
    async function fetchProjectsOnce() {
        if (!supabase) return;
        showLoading(true);
        try {
            const { data, error } = await supabase
                .from(TABLE_NAME)
                .select('*')
                .order('timestamp', { ascending: false }); // Sort newest first

            if (error) {
                 // Throw the error to be caught below
                 throw error;
            }

            projects = data || [];
            console.log("Projects loaded from Supabase:", projects.length);
            
            // Re-render the current page if it's the Showcase or Admin page
            if (currentPage === 'showcase' || currentPage === 'admin') {
                navigate(currentPage, false); // Re-render without changing nav state
            }
        } catch (error) {
            console.error("Error fetching projects:", error.message);
            // Display an error message if loading fails severely
            if (error.code !== '401') { // 401 on SELECT is uncommon, but 42501 could happen if RLS is wrong
                 showMessageBox('Data Error', `Failed to load projects: ${error.message}. Check RLS policy for 'SELECT'.`);
            }
        } finally {
            showLoading(false);
        }
    }

    // --- SUPABASE AUTHENTICATION FUNCTIONS (New) ---
    async function attemptAdminLogin() {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        const messageElement = document.getElementById('auth-message');
        
        messageElement.textContent = 'Logging in...';

        try {
            // New Supabase Auth Sign-in
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            
            if (error) {
                console.error("Login failed:", error);
                messageElement.textContent = `Login Failed: ${error.message}`;
                return;
            }

            // onAuthStateChange handles setting isAdminAuthenticated and navigation
            messageElement.textContent = 'Login successful! Redirecting...';

        } catch (error) {
            console.error("An unexpected error occurred during login:", error);
            messageElement.textContent = 'An unexpected error occurred.';
        }
    }
    
    async function signOutAdmin() {
        if (!supabase) return;
        try {
            await supabase.auth.signOut();
            showMessageBox('Signed Out', 'You have been signed out successfully.');
            navigate('admin', true);
        } catch(error) {
            console.error("Sign out failed:", error);
        }
    }


    // --- CRUD OPERATIONS ---

    async function saveProject(projectId, data) {
        // Now checks for proper Supabase authentication
        if (!isAdminAuthenticated || !supabase) {
            showMessageBox('Access Denied', 'You must be logged in as an administrator via email/password to perform this action.');
            return;
        }
        showLoading(true);
        try {
            let result;
            if (projectId) {
                // Update
                result = await supabase
                    .from(TABLE_NAME)
                    .update(data)
                    .eq('id', projectId)
                    .select();
            } else {
                // Insert 
                result = await supabase
                    .from(TABLE_NAME)
                    .insert(data)
                    .select();
            }

            if (result.error) throw result.error;
            
            console.log("Project saved successfully.");
            await fetchProjectsOnce(); // Explicitly re-fetch data after operation

        } catch (error) {
            console.error("Error saving project:", error);
            showMessageBox('Error', `Failed to save project. Ensure you have run the **RLS Update SQL** to grant authenticated users write access. Details: ${error.message}`);
        } finally {
            showLoading(false);
        }
    }

    async function deleteProject(projectId) {
        if (!isAdminAuthenticated || !supabase) {
            showMessageBox('Access Denied', 'You must be logged in as an administrator via email/password to perform this action.');
            return;
        }
        
        showConfirmBox('Confirm Deletion', 'Are you sure you want to permanently delete this project?', async () => {
            showLoading(true);
            try {
                const { error } = await supabase
                    .from(TABLE_NAME)
                    .delete()
                    .eq('id', projectId);

                if (error) throw error;

                console.log("Project deleted successfully.");
                await fetchProjectsOnce(); // Explicitly re-fetch data after operation
                
            } catch (error) {
                console.error("Error deleting project:", error);
                showMessageBox('Error', `Failed to delete project. Ensure you have run the **RLS Update SQL** to grant authenticated users delete access. Details: ${error.message}`);
            } finally {
                showLoading(false);
            }
        });
    }
    
    // --- PAGE RENDERING LOGIC ---

    function renderHome() {
        return `
            <section id="home-section" class="space-y-12">
                <div class="text-center py-20 bg-gray-800 rounded-3xl shadow-2xl border border-yellow-500/30">
                    <h1 class="text-6xl font-extrabold mb-4 text-white leading-tight">
                        Your vision, Elevated.
                    </h1>
                    <p class="text-xl text-gray-400 max-w-3xl mx-auto mb-8">
                        King & Co. Design delivers custom interior architecture for Los Santos' most demanding clients. From your Goverment apartment to stunning luxury homes.
                    </p>
                    <button onclick="navigate('contact')" class="px-8 py-3 bg-yellow-500 text-gray-900 font-bold rounded-full shadow-lg hover:bg-yellow-400 transition duration-300 transform hover:scale-105">
                        Start Your Project Today
                    </button>
                </div>

                <div class="bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-700">
                    <h2 class="text-3xl font-bold text-yellow-400 mb-6 flex items-center">
                        <i data-lucide="calculator" class="w-6 h-6 mr-3"></i> Design Fee Estimator
                    </h2>
                    <p class="text-gray-400 mb-6">Estimate the **Labor Fee** and view estimated material range based on your property scope and furnishing budget.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="scope" class="block text-sm font-medium text-gray-300 mb-1">Property Size / Scope:</label>
                            <select id="scope" onchange="calculateQuote()" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-white">
                                <option value="5000">Government Apartment</option>
                                <option value="7500">Tiny Apartment</option>
                                <option value="12000">Small Apartment / Home</option>
                                <option value="20000">Medium House</option>
                                <option value="50000">Large House / Mansion</option>
                                <option value="75000">Warehouse / Custom Build (Requires Consultation)</option>
                            </select>
                        </div>

                        <div>
                            <label for="furnishing-budget" class="block text-sm font-medium text-gray-300 mb-1">Furnishing Budget (Materials & Items):</label>
                            <select id="furnishing-budget" onchange="calculateQuote()" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-white">
                                <option value="1000">Budget: $1,000 - $5,000</option>
                                <option value="5000">Mid-Range: $5,000 - $10,000</option>
                                <option value="10000">High-End: $10,000 - $20,000</option>
                                <option value="20000">Luxury: $20,000 - $50,000</option>
                                <option value="50000">Take My Money!: $50,000+</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="pt-6">
                        <h3 class="text-xl font-semibold text-gray-200">Estimated Project Costs:</h3>
                        
                        <p class="text-sm text-gray-400 mt-2 mb-1">Estimated Labor Fee (Architect):</p>
                        <p id="labor-fee-output" class="text-2xl font-bold text-yellow-500">$5,000</p>
                        
                        <p class="text-sm text-gray-400 mt-4 mb-1">Minimum Furnishing/Materials Budget:</p>
                        <p id="budget-output" class="text-2xl font-bold text-gray-300">$1,000</p>

                        <div class="mt-6 border-t border-gray-600 pt-4">
                             <p class="text-sm text-gray-200 mb-1">Total Minimum Estimated Project Cost (Fee + Min Budget):</p>
                             <p id="total-output" class="text-4xl font-extrabold text-yellow-400">$6,000</p>
                        </div>

                        <p class="text-sm text-red-400 mt-4 font-semibold p-3 bg-red-900/20 rounded-lg border border-red-700/50">
                            <i data-lucide="wallet" class="w-4 h-4 inline mr-2 align-text-bottom"></i>
                            A **70% up-front payment** of the **Total Minimum Estimated Project Cost** is required to begin design work.
                        </p>
                        <p class="text-xs text-gray-500 mt-4">
                            *Estimate only. The Labor Fee is fixed by the selected scope. The Furnishing/Materials Budget shown is the **minimum** for that bracket and is for client purchase of items. Final price determined upon consultation.
                        </p>
                    </div>
                </div>
            </section>
        `;
    }

    function calculateQuote() {
        const scopeElement = document.getElementById('scope');
        const budgetElement = document.getElementById('furnishing-budget');
        
        if (!scopeElement || !budgetElement) return;

        const fee = parseFloat(scopeElement.value);
        // We need to use the value (the number) for calculation, but the text for display
        const budgetMin = parseFloat(budgetElement.value); 
        const budgetText = budgetElement.options[budgetElement.selectedIndex].text.split(': ')[1];
        
        const total = fee + budgetMin;

        // Output formatting
        const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });

        document.getElementById('labor-fee-output').textContent = formatter.format(fee);
        document.getElementById('budget-output').textContent = formatter.format(budgetMin);
        
        // Show the Total
        document.getElementById('total-output').textContent = formatter.format(total);
    }

    function renderContact() {
        const staffList = MOCK_STAFF.map(staff => `
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-yellow-500/20 transition duration-300 border border-gray-700">
                <div class="flex items-center mb-4">
                    <div class="p-3 bg-yellow-500 rounded-full text-gray-900 mr-4">
                        <i data-lucide="${staff.icon}" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-white">${staff.name}</h3>
                        <p class="text-yellow-400 font-medium">${staff.role}</p>
                    </div>
                </div>
                <div class="space-y-2">
                    <p class="text-sm text-gray-300">
                        <span class="font-semibold text-gray-100">Specialty:</span> ${staff.specialty}
                    </p>
                    <p class="text-sm text-gray-300">
                        <span class="font-semibold text-gray-100">Contact:</span> ${staff.contact}
                    </p>
                </div>
            </div>
        `).join('');

        return `
            <section id="contact-section" class="space-y-8">
                <h2 class="text-4xl font-extrabold text-center text-yellow-500">Meet Our Design Team</h2>
                <p class="text-center text-gray-400 max-w-2xl mx-auto">
                    Contact the specialist whose expertise best matches your vision. We handle all inquiries through our official channels.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-4">
                    ${staffList}
                </div>
            </section>
        `;
    }

    function renderShowcase() {
        if (projects.length === 0) {
            return `
                <section id="showcase-section" class="space-y-8">
                    <h2 class="text-4xl font-extrabold text-center text-yellow-500">Featured Projects</h2>
                    <p class="text-center text-gray-400 max-w-2xl mx-auto">
                        A selection of our most complex and our favorite property renovations across Los Santos.
                    </p>
                    <div class="text-center py-10 text-gray-500">
                        <i data-lucide="archive" class="w-12 h-12 mx-auto mb-4"></i>
                        <p class="text-lg">No projects currently listed. Check back soon!</p>
                    </div>
                </section>
            `;
        }
        
        // Projects are already sorted by fetchProjectsOnce
        const projectCards = projects.map(project => {
            // Handle potentially empty or malformed image string
            const imageUrls = project.images ? project.images.split(',') : [];
            const firstImage = imageUrls[0] ? imageUrls[0].trim() : '';

            return `
                <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden transition duration-300 hover:shadow-yellow-500/30 border border-gray-700">
                    <div class="relative h-48 bg-gray-700 flex items-center justify-center text-gray-400 font-mono text-lg">
                        <img src="${firstImage}" 
                             onerror="this.onerror=null;this.src='https://placehold.co/800x600/1f2937/d1d5db?text=Project+Thumbnail';" 
                             alt="${project.title} Thumbnail" 
                             class="absolute inset-0 w-full h-full object-cover">
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-white mb-2">${project.title}</h3>
                        <p class="text-sm text-gray-400 mb-4 line-clamp-2">${project.description}</p>
                        <p class="text-xs text-gray-500">Designer: <span class="text-yellow-400">${project.designer}</span></p>
                        <button onclick="openModal('${project.id}')" class="mt-4 w-full py-2 bg-yellow-500 text-gray-900 font-semibold rounded-lg hover:bg-yellow-400 transition duration-300">
                            View Project Details
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        return `
            <section id="showcase-section" class="space-y-8">
                <h2 class="text-4xl font-extrabold text-center text-yellow-500">Featured Projects</h2>
                <p class="text-center text-gray-400 max-w-2xl mx-auto">
                    A selection of our most complex and our favorite property renovations across Los Santos.
                </p>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 pt-4">
                    ${projectCards}
                </div>
            </section>
        `;
    }
    
    // --- ADMIN RENDERING (Updated for Supabase Auth) ---

    function renderAdminAuth() {
        return `
            <section id="admin-auth" class="max-w-md mx-auto space-y-6">
                <h2 class="text-4xl font-extrabold text-yellow-500 text-center">Admin Login</h2>
                <div class="bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-700 space-y-4">
                    <p class="text-gray-400">Sign in with your Supabase Admin email and password to manage projects.</p>
                    <form id="admin-login-form" onsubmit="event.preventDefault(); attemptAdminLogin();">
                        <div>
                            <label for="admin-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                            <input type="email" id="admin-email" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="User@KingCo.com">
                        </div>
                         <div>
                            <label for="admin-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                            <input type="password" id="admin-password" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        </div>
                        <p id="auth-message" class="text-sm text-red-400 h-5 mt-2"></p>
                        <button type="submit" class="w-full mt-4 py-3 bg-yellow-500 text-gray-900 font-bold rounded-full shadow-lg hover:bg-yellow-400 transition">
                            Sign In
                        </button>
                    </form>
                </div>
                <p class="text-center text-gray-500 text-sm">
                    Note: You must first create a user in your Supabase Auth panel to sign in.
                </p>
            </section>
        `;
    }
    
    function renderAdmin(projectToEdit = null) {
        if (!isAdminAuthenticated) {
            return renderAdminAuth();
        }

        const formTitle = projectToEdit ? 'Edit Project' : 'Add New Project';
        
        // MODIFICATION 1: Stop designer name from auto-filling for new projects
        const defaultDesigner = projectToEdit ? projectToEdit.designer : '';
        const project = projectToEdit || { title: '', designer: defaultDesigner, description: '', comment: '', images: '' };

        // Split images string for form fields
        const existingImages = project.images ? project.images.split(',').map(img => img.trim()) : [];
        const imageInputs = [];
        // Loop to create 8 separate image link inputs
        for (let i = 0; i < 8; i++) {
            const imageUrl = existingImages[i] || '';
            imageInputs.push(`
                <div>
                    <label for="image-${i+1}" class="block text-sm font-medium text-gray-300 mb-1">Image Link ${i+1} (${i === 0 ? 'Primary' : 'Optional'})</label>
                    <input type="url" id="image-${i+1}" value="${imageUrl}" ${i === 0 ? 'required' : ''} class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white" placeholder="https://image-link.com/photo${i+1}.jpg">
                </div>
            `);
        }

        const projectList = projects.map(p => `
            <li class="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-700 p-4 rounded-lg border border-gray-600">
                <span class="text-white font-medium mb-2 sm:mb-0">${p.title} <span class="text-sm text-gray-400">by ${p.designer}</span></span>
                <div class="flex space-x-2">
                    <button onclick="navigate('admin', true, '${p.id}')" class="p-2 text-yellow-400 hover:text-yellow-300 transition" title="Edit">
                        <i data-lucide="square-pen" class="w-5 h-5"></i>
                    </button>
                    <button onclick="deleteProject('${p.id}')" class="p-2 text-red-400 hover:text-red-300 transition" title="Delete">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </li>
        `).join('');

        return `
            <section id="admin-section" class="space-y-12">
                <h2 class="text-4xl font-extrabold text-yellow-500 flex items-center">
                    <i data-lucide="settings-2" class="w-8 h-8 mr-3"></i> Admin Panel
                </h2>
                <p class="text-sm text-gray-500 flex items-center justify-between">
                    <span>Current Admin: <span class="font-mono text-yellow-400 break-all">${userId}</span></span>
                    <button onclick="signOutAdmin()" class="px-4 py-2 text-sm bg-red-600 text-white font-medium rounded-lg hover:bg-red-500 transition">
                        Sign Out
                    </button>
                </p>
                
                <div class="bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-700">
                    <h3 class="text-2xl font-bold text-yellow-400 mb-6">${formTitle}</h3>
                    <form id="project-form" class="space-y-4">
                        <input type="hidden" id="project-id" value="${projectToEdit ? project.id : ''}">
                        
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Title</label>
                            <input type="text" id="title" value="${project.title}" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        </div>
                        
                        <div>
                            <label for="designer" class="block text-sm font-medium text-gray-300 mb-1">Designer Name</label>
                            <input type="text" id="designer" value="${project.designer}" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        </div>

                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-300 mb-1">Short Description (for card view)</label>
                            <textarea id="description" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">${project.description}</textarea>
                        </div>

                        <div>
                            <label for="comment" class="block text-sm font-medium text-gray-300 mb-1">Designer Comment (for modal)</label>
                            <textarea id="comment" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">${project.comment}</textarea>
                        </div>
                        
                        <h4 class="text-xl font-semibold text-gray-300 pt-4 pb-2">Project Image Links (Max 8)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${imageInputs.join('')}
                        </div>
                        <div class="flex justify-between items-center pt-2">
                            <button type="submit" class="px-6 py-3 bg-yellow-500 text-gray-900 font-bold rounded-full shadow-lg hover:bg-yellow-400 transition">
                                ${projectToEdit ? 'Update Project' : 'Create Project'}
                            </button>
                            ${projectToEdit ? `<button type="button" onclick="navigate('admin')" class="text-gray-400 hover:text-white transition">Cancel Edit</button>` : ''}
                        </div>
                    </form>
                </div>
                
                <div class="bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-700">
                    <h3 class="text-2xl font-bold text-yellow-400 mb-6 flex items-center">
                        <i data-lucide="list-checks" class="w-6 h-6 mr-3"></i> Manage Existing Projects (${projects.length})
                    </h3>
                    <ul class="space-y-3">
                        ${projectList || '<li class="text-gray-400 italic">No projects found. Add one above!</li>'}
                    </ul>
                </div>
            </section>
        `;
    }
    
    // --- NAVIGATION AND INIT (Moved to global scope) ---

    function openModal(projectId) {
        const project = projects.find(p => p.id === projectId);
        if (!project) return;

        modalTitle.textContent = project.title;
        
        // The project.images is still a comma-separated string from the database
        // Filter and map the image URLs
        const imageUrls = project.images.split(',').map(url => url.trim()).filter(url => url.length > 0);

        // Set initial image index to 0 for a new project view
        currentImageIndex = 0; 

        // MODIFICATION 2: Updated modal content for slideshow
        // Note: The JSON.stringify().replace() trick is needed to safely pass the array to the global onclick functions in HTML
        const imageUrlsString = JSON.stringify(imageUrls).replace(/"/g, '&quot;');
        
        modalContent.innerHTML = `
            <p class="text-lg text-gray-300 mb-4">${project.description}</p>
            <div class="bg-yellow-900/40 border border-yellow-500/50 p-4 rounded-lg">
                <p class="font-semibold text-yellow-400 mb-2 flex items-center">
                    <i data-lucide="message-square" class="w-4 h-4 mr-2"></i> Designer Comments:
                </p>
                <p class="text-gray-200 italic">${project.comment}</p>
                <p class="text-xs mt-2 text-yellow-300/80">â€” ${project.designer}</p>
            </div>
            
            <h4 class="text-xl font-semibold text-white mt-6 mb-4">Gallery (${imageUrls.length} Photos)</h4>
            
            <div class="relative flex items-center justify-center bg-gray-900 rounded-xl p-2 min-h-64 shadow-inner">
                <button id="prev-image-btn" onclick="prevImage(${imageUrlsString})" 
                        class="absolute left-2 z-20 p-3 bg-black/50 hover:bg-black/70 rounded-full text-white transition disabled:opacity-50">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                
                <div id="image-slideshow-container" class="w-full text-center">
                    </div>
                
                <button id="next-image-btn" onclick="nextImage(${imageUrlsString})" 
                        class="absolute right-2 z-20 p-3 bg-black/50 hover:bg-black/70 rounded-full text-white transition disabled:opacity-50">
                    <i data-lucide="chevron-right" class="w-6 h-6"></i>
                </button>
            </div>
            <p id="image-counter" class="text-center text-sm text-gray-400 mt-2"></p>
            `;

        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden'); // Prevent background scrolling
        renderIcons(); // Re-render icons in modal
        
        // Initial display of the first image
        if (imageUrls.length > 0) {
             showImage(imageUrls);
        } else {
            // Fallback message if no images are present
            document.getElementById('image-slideshow-container').innerHTML = 
                '<p class="text-lg text-gray-500 py-10">No images available for this project.</p>';
        }
    }

    function navigate(page, skipNavUpdate = false, editProjectId = null) {
        if (page === 'admin' && editProjectId) {
            const projectToEdit = projects.find(p => p.id === editProjectId);
            if (!projectToEdit) {
                console.error("Project not found for editing:", editProjectId);
                page = 'admin'; // Fallback to main admin view
            }
            appContainer.innerHTML = renderAdmin(projectToEdit);
        } else if (page === 'admin') {
            appContainer.innerHTML = renderAdmin();
        } else {
            const content = page === 'home' ? renderHome()
                        : page === 'contact' ? renderContact()
                        : page === 'showcase' ? renderShowcase()
                        : ''; 
            appContainer.innerHTML = content;
        }

        currentPage = page;

        if (!skipNavUpdate) {
            // Update active navigation link styling
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-yellow-600', 'text-gray-900');
                link.classList.add('text-gray-300', 'hover:text-yellow-400');
                if (link.getAttribute('data-page') === page) {
                    link.classList.add('bg-yellow-600', 'text-gray-900', 'hover:text-gray-900');
                    link.classList.remove('text-gray-300', 'hover:text-yellow-400');
                }
            });
        }


        // Re-render Lucide icons and attach event listeners
        renderIcons();
        if (page === 'home') {
            setTimeout(() => {
                const scopeElement = document.getElementById('scope');
                const budgetElement = document.getElementById('furnishing-budget');
                if (scopeElement && budgetElement) {
                    // Ensure the default calculation runs when the page loads
                    calculateQuote();
                }
            }, 0);
        }
        
        // Add submit listener for Admin form
        if (page === 'admin' && isAdminAuthenticated) {
            const form = document.getElementById('project-form');
            if (form) {
                form.onsubmit = (e) => {
                    e.preventDefault();
                    const projectId = document.getElementById('project-id').value;
                    
                    // Collect all 8 image inputs and filter out empty ones
                    const imageLinks = [];
                    for (let i = 1; i <= 8; i++) {
                        const link = document.getElementById(`image-${i}`).value.trim();
                        if (link) {
                            imageLinks.push(link);
                        }
                    }
                    
                    const data = {
                        title: document.getElementById('title').value,
                        designer: document.getElementById('designer').value,
                        description: document.getElementById('description').value,
                        comment: document.getElementById('comment').value,
                        // Combine image URLs into a single comma-separated string for the database
                        images: imageLinks.join(','), 
                        timestamp: Date.now() // For sorting/tracking
                    };
                    
                    saveProject(projectId, data).then(() => {
                        // Return to the main admin view after save
                        navigate('admin', true);
                    });
                };
            }
        }
    }


    // Initial load
    window.onload = () => {
        // 1. Setup Supabase Client and Auth Listener
        setupSupabase();
        // 2. Navigate to default page
        navigate('home');
    };
</script>

</body>
</html>